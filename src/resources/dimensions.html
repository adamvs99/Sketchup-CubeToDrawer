<!DOCTYPE html>
<html>
    <head>
        <title>Box to Drawer Parameters</title>
        <style>
            body { font-family: sans-serif; }
            button {
                padding: 10px 15px;
                border-radius: 10px;
            }
            button:focus {
                background-color: #23019b;
                color: white;
            }
            .center {
                text-align: center;
                border: 3px solid green;
            }
            .center_editable {
                text-align: center;
                width: 100px;
                font-weight: bold;
                #font-size: 1.15em;
            }
            .unit_noneditable {
                text-align: left;
                width: 30px;
                border: none;
                color: darkblue;
                #font-size: 1.15em;
                font-weight: bold;
            }
            .images {
                vertical-align: middle;
                horiz-align: center;
                height: 120px;
                margin: auto;
                margin-top: 10px;
                width: 120px;
                position: relative;
            }
            img { display: none;}
        </style>
    </head>
    <body>
    <h3 style="text-align: center;">Box to Drawer Parameters</h3>
    <div class="center">
        <h3>Thickness of drawer panels</h3>
        <p>
            <label for="sheet_thickness">Sheet Thickness:</label>
            <input class="center_editable" type="text" id="sheet_thickness" name="sheet_thickness" tabindex="1">
            <input class="unit_noneditable" type="text" id="sheet_units" name="sheet_units" readonly="readonly" tabindex="-1">
        </p>
        <p>
            <label for="dado_thickness">Dado Thickness:</label>
            <input class="center_editable" type="text" id="dado_thickness" name="dado_thickness" tabindex="2">
            <input class="unit_noneditable" type="text" id="dado_thickness_units" name="dado_thickness_units" readonly="readonly" tabindex="-1">
        </p>
        <p>
            <label for="dado_depth">Dado Depth:</label>
            <input class="center_editable" type="text" id="dado_depth" name="dado_depth" tabindex="3">
            <input class="unit_noneditable" type="text" id="dado_depth_units" name="dado_depth_units" readonly="readonly" tabindex="-1">
        </p>
        <p>
            <label for="drawer_type_select">Drawer Type:</label>
            <select id="drawer_type_select" name="myDropdownName">
                <option value="simple_drawer">Super Simple</option>
                <option value="pocket_screw_drawer">Pocket Screw</option>
                <option value="advanced_dado_drawer">Super Drawer</option>
            </select>
        </p>
        <p>
            <button onclick="sendDataToSketchUp('defaults')" id="save_as_defaults" tabindex="6">Save As Defaults</button>
            <button onclick="sendDataToSketchUp('data')" id="update_button" tabindex="5">Update</button>
            <button onclick="sendDataToSketchUp('quit')" id="quit_button" tabindex="-1">Cancel</button>
        </p>
    </div>
    <div class="images">
        <img id="sheet_thickness_img" alt="sheetThickness">
        <img id="dado_thickness_img" alt="dadoWidth">
        <img id="dado_depth_img" alt="dadoDepth">
    </div>
    <script>
        function sendDataToSketchUp(how) {
            var sheetThickness = document.getElementById('sheet_thickness').value;
            var dadoWidth = document.getElementById('dado_thickness').value;
            var dadoDepth = document.getElementById('dado_depth').value;

            if (how == 'defaults') {
                sketchup.updateDefaultsValues(sheetThickness, dadoWidth, dadoDepth);
            }
            else if (how == 'data'){
                sketchup.updateDimensionsValues(sheetThickness, dadoWidth, dadoDepth);
            }// 'updateDialogValues' is a Ruby callback
            else if (how == 'quit') {
                sketchup.closeDialog();
            }

        }

        // handle focus in events for input fields
        document.getElementById("sheet_thickness").addEventListener('focusin', function() {
            document.getElementById('sheet_thickness').select();
            document.getElementById("sheet_thickness_img").style.display="block";
        });
        document.getElementById("dado_thickness").addEventListener('focusin', function() {
            document.getElementById('dado_thickness').select();
            document.getElementById("dado_thickness_img").style.display="block";
        });
        document.getElementById("dado_depth").addEventListener('focusin', function() {
            document.getElementById('dado_depth').select();
            document.getElementById("dado_depth_img").style.display = "block";
        });

        // handle focus out events for input fields
        document.getElementById("sheet_thickness").addEventListener('focusout', function() {
            document.getElementById("sheet_thickness_img").style.display="none";
            inputNumberFormat("sheet_thickness");
        });
        document.getElementById("dado_thickness").addEventListener('focusout', function() {
            document.getElementById("dado_thickness_img").style.display="none";
            inputNumberFormat("dado_thickness");
        });
        document.getElementById("dado_depth").addEventListener('focusout', function() {
            document.getElementById("dado_depth_img").style.display = "none";
            inputNumberFormat("dado_depth");
        });
        
        document.getElementById("drawer_type_select").addEventListener("change", (event) => {
            sketchup.new_drawer_type(event.target.value);
        });

        // Live validation: turn text red on invalid input and disable Update
        // Helpers for live validation
        function isValidNumberStr(str) {
            if (str == null) return false;
            const s = String(str).trim();
            if (s === '') return false;
            const matches = /^[-+]?\d{0,3}\.{0,1}\d{0,4}$/.exec(s);
            if (matches == null) return false;
            if (matches[0] != s) return false;
            const n = parseFloat(s);
            return !Number.isNaN(n) && Number.isFinite(n) && n > 0.001
        }

        function markValidity(inputEl, valid) {
            inputEl.style.color = valid ? 'black' : 'red';
        }

        function anyInvalid() {
            const ids = ['sheet_thickness', 'dado_thickness', 'dado_depth'];
            return ids.some(id => !isValidNumberStr(document.getElementById(id).value));
        }

        function updateButtonState() {
            const invalid = anyInvalid();
            document.getElementById('save_as_defaults').disabled = invalid;
            document.getElementById('update_button').disabled = invalid;
        }

        function inputNumberFormat(elementID) {
            const inputElement = document.getElementById(elementID);
            var inputValue = inputElement.value;
            inputValue = inputValue.trim();
            if (isValidNumberStr(inputValue)) {
                const numberValue = parseFloat(inputValue);
                inputElement.value = numberValue.toFixed(2);
            }
        }

        ['sheet_thickness', 'dado_thickness', 'dado_depth'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', (event) => {
                const val = event.target.value
                const valid = isValidNumberStr(val);
                markValidity(event.target, valid);
                updateButtonState();
            });
        });

        function setInitialValue(elementID, val) {
            const inputElement = document.getElementById(elementID);
            const valid = isValidNumberStr(val);
            inputElement.value = val;
            markValidity(inputElement, valid);
            updateButtonState();
        }

        document.addEventListener('DOMContentLoaded', function() {
            sketchup.dom_loaded();
        });
    </script>
    </body>
</html>

